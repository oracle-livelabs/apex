# Using External Modules

## Introduction
In this lab, you will learn how to load external JavaScript modules. The modules will be saved in a local new table and the code for the modules will be fetched from that table.
You will utilize the following three external JavaScrip libraries/modules:

- Email Verification
- QR Code generation
- Markdown conversion to HTML

Estimated Lab Time: 20 minutes

## Task 1: Loading External JavaScript Modules

1. Click on the green arrow next to **SQL Workshop**

    ![](images/0-0-sql-scripts.png " ")
   
   Then click on **SQL Script**

   Click on **Create** button and set the Script Name to **javascript modules**

    ![](images/0-1-create-script.png " ")

    Copy the following code:

    ```
    <copy>
    create table mle_module (
        id                             number generated by default on null as identity 
                                    constraint mle_module_id_pk primary key,
        name                           varchar2(255 char)
                                    constraint mle_module_name_unq unique,
        link                           varchar2(4000 char),
        content                        clob,
        created                        timestamp with local time zone not null,
        created_by                     varchar2(255 char) not null,
        updated                        timestamp with local time zone not null,
        updated_by                     varchar2(255 char) not null
    )
    ;


    -- triggers
    create or replace trigger mle_module_biu
        before insert or update 
        on mle_module
        for each row
    begin
        if inserting then
            :new.created := localtimestamp;
            :new.created_by := coalesce(sys_context('APEX$SESSION','APP_USER'),user);
        end if;
        :new.updated := localtimestamp;
        :new.updated_by := coalesce(sys_context('APEX$SESSION','APP_USER'),user);
    end mle_module_biu;
    /

    declare
        l_code clob;
        TYPE t_module_rec IS RECORD (name mle_module.name%TYPE,
                                    link mle_module.link%TYPE);
        TYPE t_module_tab IS TABLE OF t_module_rec INDEX BY PLS_INTEGER;
        module_tab t_module_tab;                             
    begin    
        module_tab(1).name := 'marked'; 
        module_tab(1).link := 'https://cdnjs.cloudflare.com/ajax/libs/marked/1.2.9/marked.min.js';     
        module_tab(2).name := 'qrcode'; 
        module_tab(2).link := 'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js';     
        module_tab(3).name := 'validator'; 
        module_tab(3).link := 'https://cdnjs.cloudflare.com/ajax/libs/validator/13.5.2/validator.min.js'; 


        FOR i IN module_tab.first .. module_tab.last 
        LOOP 
            dbms_output.put_line(module_tab(i).name||': '||module_tab(i).link);
            l_code := apex_web_service.make_rest_request(module_tab(i).link, 'GET');
            begin
                insert
                into mle_module (name, link, content)
                values (module_tab(i).name, module_tab(i).link, l_code);
                EXCEPTION   
                WHEN OTHERS THEN
                    null;
            end;
        END LOOP;   
    end;
    </copy>
    ```

    Click on **Run** button

    ![](images/0-2-load-external-modules.png " ")

    The code will create a table called mle_modules and fetch the three external JavaScript modules into the table

    

2. Click on **Run Now** Button
    
    ![](images/0-3-load-external-modules.png " ")

3. Review the result. You should have 3 successful statements.

    ![](images/0-4-load-external-modules.png " ")

## Task 2: Preparing the Form

1. Let's add an email column to project_tasks table

    Copy and run the following code in **SQL Commands**:

    ```
    <copy>
    alter table project_tasks add (email varchar(255), url varchar2(255), project_details varchar2(4000));
    </copy>
    ```

    ![](images/1-add-columns.png " ")

2. Navigate to **Page 5** in **Page Designer**

    ![](images/2-project-task-form.png " ")

3. Right click on **Items** and click the **Create Page Item** menu item

    ![](images/3-create-email.png " ")

4. Set the property values for the new item as the following:
    
    **Name** => **P5_EMAIL**
    
    **Form Region** => **Project Task**
    
    **Column** => **EMAIL**

    **Data Type** => **VARCHAR2**

    ![](images/4-set-email-item.png " ")

5. Select P5_STATUS and set the property values as the following:

    **Sequence** => **35**
    
    **Start New Row** => **Disabled**    

    ![](images/5-status-item.png " ")

6. Click on **P5\_END\_DATE** and hold the **Control** Key and click on **P5_BUDGET**. Both items will be selected now. Update the **Start New Row** value to **disabled**.

    ![](images/6-start-date-budget.png " ")

7. Select P5_EMAIL and update the property values as the following:

    **Sequence** => **75**

    **Start New Row** => **Disabled**

    ![](images/7-email-item.png " ")

8. Right click on **Project Task** form region and click on **Create Sub Region** menu item

    ![](images/8-selector-region.png " ")

9. Update the property values for the new Sub Region as the following:

    **Title** => **Display Selectors** 
    
    **Type** => **Region Display Selectors**

    ![](images/9-selector-region2.png " ")


10. Right click on **Display Selectors** Sub Region and click on the **Create Sub Region** menu item. 
        
    ![](images/9-selector-region-sub1.png " ")

11. Call the new Sub Region **Main** and set the **Template** to **Blank with Attributes**
    
    ![](images/9-selector-region-sub1-details.png " ")

12. Right click on the **Main** region and click on **Duplicate** menu item and name the new region **QR Code**

    Repeat the process and by right clicking on the **Main** region and create another duplicate called **Markdown Details** this time

    ![](images/9-selector-region-sub2.png " ")

    You should have 3 sub regions under the Display Selectors region now

    ![](images/9-selector-region-sub3.png " ")

13. Click on **P5\_ID** page item and hold the **Shift** key and then click on **P5\_BUDGET** item

    Drag and Drop the selected items and place them under the **Main** region

    ![](images/9-selector-region-sub-drag.png " ")

14. Select the Display Selectors region and set the property valuse to the following:

    **Template** => **Tabs Container**

    Click on **Template Options** and set the followings:

    Enable **Remember Active Tab** attribute

    **Tabs Size** => **Large**

    Click on **Save** button

    ![](images/10-selector-region.png " ")

15. Navigate to Project Tasks Report page in the application. 

    Click on the edit icon of the first row and observe the new design for the form page

    ![](images/11-page-5.png " ")

## Task 3: Loading External JavaScript Modules
Now that our form is design ready, it is time to create a process that will fetch the JavaScript library from the mle_module table.

1. Go to the **Shared Components** of the application in the **App Builder**
   
   Click on **Application Processes** link

    ![](images/12-shared-components.png " ")

2. Click on Create button and set the followings:
   
   **Name** => **Setup MLE**

   **Point** => **On Submit: After Page Submission - Before Computations and Validations**

    Click **Next** button

    ![](images/13-setup-mle.png " ")

3. Set the **Language** attribute to **JavaScript (MLE)**

    Copy and use the following JavaScript code:

    ```
    <copy>
    const loadFromDatabase = (moduleName) => {
        var result = apex.conn.execute('select content from mle_module where name = :name', {
            name: moduleName
        }, {
            fetchInfo: {
                CONTENT: {
                    type: apex.db.STRING
                }
            }
        });
        return result.rows[0].CONTENT;
    };

    const decorateModule = (module) => `
    (function () {
    var exports = {};
    var module = {exports: exports};
    ${module};
    return module.exports;
    })();`;

    const moduleCache = {};

    globalThis.requireModule = (moduleName) => {
        if (!moduleCache[moduleName]) {
            const moduleString = decorateModule(loadFromDatabase(moduleName));
            moduleCache[moduleName] = Polyglot.eval('js', moduleString);
        }
        return moduleCache[moduleName];
    };

    globalThis.loadScript = function(scriptName){
        Polyglot.eval('js', loadFromDatabase(scriptName));
    };
    </copy>
    ```

    Click **Next** button

    ![](images/14-setup-mle2.png " ")

4. Click on **Create Process** button

    ![](images/15-setup-mle3.png " ")

5. The new process is created and it will run before compuations and validations to fetch any required JavaScript module from mle_module table

    Click on **Edit Page** button on top right

    ![](images/16-setup-mle4.png " ")

## Task 4: Email Validation

1. In the top of the **Page Designer** type **5** and click **Go** button to start editing Page 5

    ![](images/17-go-page5.png " ")

2. Right click on **P5_EMAIL** page item and then click on **Create Validation** menu item

    ![](images/18-email-validation1.png " ")

3. Set the property values for the new validation to the followings:
    
    **Name** => **Is Valid Email?**

    **Language** => **JavaScript (MLE)**

    **JavaScript Expression** => **requireModule('validator').isEmail(apex.env.P5_EMAIL)**

    **Error Message** => **Please enter a valid email address**

    ![](images/19-email-validation2.png " ")

4. Run **Project Tasks Report** page and click on **Edit** icon for the **Get RFPs for new server** task record. Try to update the **Email** field with the **test@test** value and click **Apply Changes**.

    The external email JavaScript module will run and validation will fail

    ![](images/20-email-validation3.png " ")

## Task 5: QR Code Generation
Next you will utilize the QR Code Generation JavaScript module to generate QR Code for the URL page item.

1. Right click on **QR Code** sub region and click on **Create Page Item** menu item

    ![](images/21-qr1.png " ")

2. Set the property values for the new item as the followings:
    
    **Name** => **P5_URL**

    **Label** => **URL**

    **Form Region** => **Project Task**

    **Column** => **URL**

    **Data Type** => **VARCHAR2**

    ![](images/22-qr2.png " ")

3. Create another page item with the following property values:
   
   **Name** => **P5_QRCODE**

   **Label** => make this blank

   **Based On** => **Image URL stored In Page Item Value**    

    ![](images/23-qr3.png " ")

4. Right click on **Region Buttons** and click on **Create Button** menu item 

    ![](images/24-qr-button.png " ")

5. Set the property values for the new button as the followings:

    **Name** => **Generate\_QR\_Code**

    **Label** => **QR Code**

    **Sequence** => **1**

    **Button Position** => **Next**

    **Hot** => **Enabled**

    ![](images/25-qr-button.png " ")

    Click on **Template Options** and set the **Style** to **Simple**

    **Database Action** => **SQL Update Action**

    ![](images/25-qr-button2.png " ")

6. Click on **Processing** tab

    Right click on **Processes** and click **Create Process** menu item

    ![](images/26-create-process.png " ")

7. Update the property values for the new process as the followings:
    
    **Name** => **Generate QR Code**

    **Language** => **JavaScript (MLE)**

    Copy and use the following **JavaScript Code**:

    ```
    <copy>
    // calling our custom requireModule function
    const qrcode = requireModule('qrcode');

    // library specific options
    const code = qrcode(0, 'L');

    code.addData(apex.env.P5_URL);

    code.make();

    // saving the base64 result into a page item of type Display Image
    apex.env.P5_QRCODE = code.createDataURL(4);
    </copy>
    ```

    **When Button Pressed** => **Generate\_QR\_Code**

    Finally click **Save** button

    ![](images/27-create-process-qr.png " ")

8. Run **Project Tasks Report** page and click on **Edit** icon for the **Get RFPs for new server** task record. 
   
    Click on **QR Code** tab

    In the **URL** field enter **apex.oracle.com**

    Click **QR Code** button

    The QR Code is generated for the entered URL

    ![](images/29-test-qr.png " ")

## Task 6: Markdown Conversion to HTML
The final step is to create a Project Details page item. The poge item will save the project details for the task in Markdown format. 

Then you will use the Markdown module to generate and preview the details in HTML.

1. Right Click on **Markdown Details** region and click on **Create Page Item** menu item

    ![](images/30-project-details.png " ")

2. Set the property values for the new created page item as the followings:

    **Name** => **P5\_PROJECT\_DETAILS**

    **Type** => **Textarea**

    **Form Region** => **Project Task**

    **Column** => **PROJECT_DETAILS**

    **Data Type** => **VARCHAR2**

    ![](images/31-project-details.png " ")

3. Create another Page item under the  **Markdown Details** region and set the property values as the followings:

     **Name** => **P5\_PROJECT_DETAILS\_HTML**

    **Type** => **Display Only**

    **Escape special characters** => **Disabled**

    ![](images/32-project-details.png " ")

4. Right click on the **Generate\_QR\_Code** button and click on **Duplicate** menu item

    ![](images/33-project-details.png " ")

5. Set the property values for the generated button as the followings:
   
   **Button Name** => **Convert_Markdown**

   **Label** => **Markdown**

    ![](images/34-project-details.png " ")

6. Click on **Processing** tab. Right click on **Processes** and click on **Create Process** menu item
   
    ![](images/35-project-details-process.png " ")

7. Set the property values for the new process as the followings:

    Name => Convert

    Language => JavaScript (MLE)

    Copy and use the following JavaScript Code:

    ```
    <copy>
    const marked = requireModule('marked');

    // library-specific options
    marked.setOptions({
        headerIds: false
    });

    apex.env.P5_PROJECT_DETAILS_HTML = marked(apex.env.P5_PROJECT_DETAILS);
    </copy>
    ```
    
    **When Button Pressed** => **Convert_Markdown**

    Click **Save** button

    ![](images/36-project-details-process.png " ")

8. Run **Project Tasks Report** page and click on **Edit** icon for the **Get RFPs for new server** task record. 

   Copy and set the **Project Details** field with the following **Markdown** code 

    ```
    <copy>
    # Project Details
    ## The following are some details about this project
      - Make sure to check this item on regular basis
      - Show Markdown in HTML region
    </copy>
    ```

    Click **Markdown** button and observe the generated HTML code

    ![](images/38-test-markdown.png " ")

## **Summary**

You now know how to load external JavaScript modules and use them in your APEX applications.

## **Learn More** - *Useful Links*

- [APEX on Autonomous](https://apex.oracle.com/autonomous)
- [APEX Collateral](https://www.oracle.com/database/technologies/appdev/apex/collateral.html)
- [Tutorials](https://apex.oracle.com/en/learn/tutorials)
- [Community](https://apex.oracle.com/community)
- [External Site + Slack](http://apex.world)

## **Acknowledgements**

 - **Author/Contributors** -  Salim Hlayel, Principal Product Manager
 - **Last Updated By/Date** - Salim Hlayel, Principal Product Manager, November 2020

